---
title: "Three patch model with vaccination"
author: "Daniela Olivera"
Date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)

# Load function file
source ("fcns.R")


# Installing requiered packages
#if ( !require(ggplot2)) install.packages("ggplot2")
#library(ggplot2)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

#### Setting up the model parameters for the model:

1. Number of patches: _npop_
2. Population in each parch: _N_
3. Individual Ro: _ro_
4. Patch recovery rate: _rec_
5. Interaction matrix betweent patches: _alpha_
6. Initital conditions for simulations: _I0_ 

```{r parameters}

# General parameters for all the models

npop <- 3
N <- c(1e6, 1e6, 1e6)
rec <- c(0.5, 0.5, 0.5)
ro <- c(1.2, 5, 15)
alpha <-
  matrix(
    c(1, 0.7, 0.3, 0.7, 1, 0.7, 0.3, 0.7, 1),
    nrow = 3,
    ncol = 3,
    byrow = TRUE
  )
I0 <- c(1, 1, 1)

#Time
tt <- seq(0, 100, length.out = 201)
```

## SIR MODEL 

```{r basic_model}


## ----- Basic SIR model  ---->

sir_mult <-   runModel("sir_mult.R",tt,np = npop,N = N,rec = rec,ro = ro,alpha = alpha,I0 = I0)

outbreakSize <- as.numeric(tail(sir_mult, 1)[1, 11:13])

outbreakSize


```


### Including vaccination: 

Same coverage for all the 3 patches

```{r SIR_Vacc_cov, message=FALSE, warning=FALSE, error= FALSE, results="hide"  }

cov_range <- seq(0, 1, length.out = 100)
cases_averted <-   data.frame(matrix(1, nrow = length(cov_range), ncol = 3))
colnames (cases_averted) <- c("Low", "Medium", "High")

for (i in c(1:length(cov_range))) {
  cov <- c(cov_range[i], cov_range[i], cov_range[i])
  R0 <- cov * N
  
  tryCatch({
    sir_vacc <- runModel("SIR_vacc.R", tt,np = npop,N = N, rec = rec,ro = ro, alpha = alpha, I0 = I0,cov = cov, vacc_time = 1,R0 = R0)
  }, error = function(e) {
   cat("ERROR :", conditionMessage(e), "\n")
  })
  
  outbreakSize_vacc <- as.numeric(tail(sir_vacc, 1)[1, 11:13])
  
  cases_averted[i, ] <- 100 * (outbreakSize - outbreakSize_vacc) / outbreakSize
  
}

cases_averted [, 4] <- cov_range
sir_averted = melt(cases_averted, id.vars = "V4")
# Plotting the model
ggplot(sir_averted, aes(x = V4, y = value, col = variable)) + geom_line() + xlab(("Coverage")) + ylab ("% Cases averted") + labs(colour = "Patch")


```

### SIS Model 

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
