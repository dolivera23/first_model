---
title: "Report 4 - Vaccination externalities"
author: "Daniela Olivera"
Date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

options(width = 2000)

knitr::opts_chunk$set(echo = TRUE, eval = TRUE)

# Load function file
source ("../fcns.R")

# Installing requiered packages
if ( !require(rootSolve)) install.packages("rootSolve")
library(rootSolve)


if ( !require(ggplot2)) install.packages("ggplot2")
library("ggplot2")



if ( !require(ggplot2)) install.packages("ggpubr")
library("ggpubr")
```

**Setting up the model parameters for the model:** 

1. Number of patches: _npop_
2. Population in each patch: _N_
3. Individual Ro: _ro_ &rarr; 1.5 -3- 9
4. Patch recovery rate: _rec_
5. Interaction matrix between patches:  **Rows of the marix must sum 1**
$$\mathbf{\alpha } = \left[\begin{array}
{rrr}
\alpha_{LL} & \alpha_{LM} & \alpha_{LH} \\
\alpha_{ML} & \alpha_{MM} & \alpha_{MH} \\
\alpha_{HL} & \alpha_{HM} & \alpha_{HH}
\end{array}\right]
$$
6. Maximum number of vaccine available: _Vmax_
7. Vaccine distribution among patches: *vacc_distr*

```{r parameters}
npop <- 3
N <- c(1e6, 1e6, 1e6)
rec <- c(0.5, 0.5, 0.5)
ro <- c(1.5,3,9)
ef <- 1
I0 <- c(1, 1, 1)

```
#### First Scenario: 

* Vaccine is avaialbe for all the population.
* The vaccine are distributed equally.
* There is NO connectivity between patches. 

$$\mathbf{\alpha } = \left[\begin{array}
{rrr}
1&  0& 0 \\
0 & 1 & 0 \\
0 & 0 & 1  
\end{array}\right]
$$ 

```{r param_change}

Vmax<- 3e6

alpha <-matrix(c(1, 0,0,0,1,0,0,0,1), nrow = 3,  ncol = 3,byrow = TRUE) 

vacc_distr <- c(1/3,1/3,1/3)

```

```{r externalities1, echo=FALSE, message=FALSE, warning=FALSE, error= FALSE}

ext <- vacc_externalities(npop=npop, alpha=alpha, rec=rec, ro=ro, N=N,ef=ef, I0=I0,Vmax=Vmax,vacc_distr=vacc_distr)

vaccine <- ext[,1]

MEV <- ext[,c(1:12)]

for (i in 2:length(vaccine)){
  
   MEV[i, c(5,6,7)] <-(ext[i, c(5,6,7)] - ext[i-1, c(5,6,7)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  MEV[i, c(8,12)] <- (ext[i, c(8,12)] - ext[i-1, c(8,12)]) / (ext[i,1] - ext[i-1,1])
  MEV[i, c(9,10,11)] <-(ext[i, c(9,10,11)] - ext[i-1, c(9,10,11)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  
  
}

pv_out <- ext[c(1,13:20)]

## ---- Plotting ---- ##
x <- MEV[2:(length(vaccine) -1),c(2,5)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "MEV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,6)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "MEV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,7)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "MEV","Patch")

plot_MEV <- rbind(x,y,z)

x <- MEV[2:(length(vaccine) -1),c(2,9)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "PV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,10)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "PV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,11)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "PV","Patch")


plot_PV <- rbind(x,y,z)


last_row <- length(vaccine) -1 

p_MEV <- plot_externalities(MEV, c(1,8,12), 2:last_row, "Vaccine", "Vaccinations", "MEV")
p_MEV_SIS <- ggplot(plot_MEV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIS")
p_MEV_SIR <- ggplot(plot_PV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIR")

big_MEV <- ggarrange(ggarrange(p_MEV_SIS, p_MEV_SIR, ncol = 2, labels = c("A", "B")), p_MEV ,nrow = 2)
annotate_figure(big_MEV,top = text_grob("Marginal effect of Vaccination ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))



p_pv <- plot_externalities(pv_out, c(1,5,9), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIS <- plot_externalities(pv_out, c(1,2,3,4), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIR <- plot_externalities(pv_out, c(1,6,7,8),2:last_row, "Vaccine", "Vaccinations", "P(v)")

big_pv <- ggarrange(ggarrange(p_pv_SIS, p_pv_SIR, ncol = 2, labels = c("A", "B")), p_pv,nrow=2)
annotate_figure(big_pv,top = text_grob("Demand curve ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))
```



#### Second Scenario: 

* Enough vaccines for all population.
* The vaccine are distributed equally.
* Patches with connectivity.

$$\mathbf{\alpha } = \left[\begin{array}
{rrr}
0.95&   0.02 & 0.03 \\
0.02 & 0.96 & 0.02 \\
0.03 & 0.02 & 0.95 
\end{array}\right]
$$ 




```{r alpha_change}
alpha <-matrix(c(0.95, 0.02, 0.03, 0.02, 0.96, 0.02, 0.03, 0.02, 0.95), nrow = 3,  ncol = 3,byrow = TRUE)

```
```{r externalities2, echo=FALSE, message=FALSE, warning=FALSE, error= FALSE}
ext <- vacc_externalities(npop=npop, alpha=alpha, rec=rec, ro=ro, N=N,ef=ef, I0=I0,Vmax=Vmax,vacc_distr=vacc_distr)

vaccine <- ext[,1]

MEV <- ext[,c(1:12)]

for (i in 2:length(vaccine)){
  
  MEV[i, c(5,6,7)] <-(ext[i, c(5,6,7)] - ext[i-1, c(5,6,7)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  MEV[i, c(8,12)] <- (ext[i, c(8,12)] - ext[i-1, c(8,12)]) / (ext[i,1] - ext[i-1,1])
  MEV[i, c(9,10,11)] <-(ext[i, c(9,10,11)] - ext[i-1, c(9,10,11)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  
  
}

pv_out <- ext[c(1,13:20)]

## ---- Plotting ---- ##
x <- MEV[2:(length(vaccine) -1),c(2,5)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "MEV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,6)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "MEV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,7)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "MEV","Patch")

plot_MEV <- rbind(x,y,z)

x <- MEV[2:(length(vaccine) -1),c(2,9)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "MEV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,10)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "MEV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,11)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "MEV","Patch")


plot_PV <- rbind(x,y,z)


last_row <- length(vaccine) -1 

p_MEV <- plot_externalities(MEV, c(1,8,12), 2:last_row, "Vaccine", "Vaccinations", "MEV")
p_MEV_SIS <- ggplot(plot_MEV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIS")
p_MEV_SIR <- ggplot(plot_PV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIR")

big_MEV <- ggarrange(ggarrange(p_MEV_SIS, p_MEV_SIR, ncol = 2, labels = c("A", "B")), p_MEV ,nrow = 2)
annotate_figure(big_MEV,top = text_grob("Marginal effect of Vaccination ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))



p_pv <- plot_externalities(pv_out, c(1,5,9), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIS <- plot_externalities(pv_out, c(1,2,3,4), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIR <- plot_externalities(pv_out, c(1,6,7,8),2:last_row, "Vaccine", "Vaccinations", "P(v)")

big_pv <- ggarrange(ggarrange(p_pv_SIS, p_pv_SIR, ncol = 2, labels = c("A", "B")), p_pv,nrow=2)
annotate_figure(big_pv,top = text_grob("Demand curve ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))

```
#### Third Scenario: 

* Vaccines for just 2/3 of the population 
* The vaccine is distributed according to burden of the disease 
* Patches with connectivity.

```{r param_change1}

Vmax<- 2e6

vacc_distr <- c(0.5,0.3,0.2)

```
 
```{r externalities3, echo=FALSE, message=FALSE, warning=FALSE, error= FALSE}
ext <- vacc_externalities(npop=npop, alpha=alpha, rec=rec, ro=ro, N=N,ef=ef, I0=I0,Vmax=Vmax,vacc_distr=vacc_distr)

vaccine <- ext[,1]

MEV <- ext[,c(1:12)]

for (i in 2:length(vaccine)){
  
  MEV[i, c(5,6,7)] <-(ext[i, c(5,6,7)] - ext[i-1, c(5,6,7)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  MEV[i, c(8,12)] <- (ext[i, c(8,12)] - ext[i-1, c(8,12)]) / (ext[i,1] - ext[i-1,1])
  MEV[i, c(9,10,11)] <-(ext[i, c(9,10,11)] - ext[i-1, c(9,10,11)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  
  
}

pv_out <- ext[c(1,13:20)]

## ---- Plotting ---- ##
x <- MEV[2:(length(vaccine) -1),c(2,5)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "MEV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,6)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "MEV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,7)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "MEV","Patch")

plot_MEV <- rbind(x,y,z)

x <- MEV[2:(length(vaccine) -1),c(2,9)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "MEV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,10)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "MEV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,11)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "MEV","Patch")


plot_PV <- rbind(x,y,z)


last_row <- length(vaccine) -1 

p_MEV <- plot_externalities(MEV, c(1,8,12), 2:last_row, "Vaccine", "Vaccinations", "MEV")
p_MEV_SIS <- ggplot(plot_MEV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIS")
p_MEV_SIR <- ggplot(plot_PV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIR")

big_MEV <- ggarrange(ggarrange(p_MEV_SIS, p_MEV_SIR, ncol = 2, labels = c("A", "B")), p_MEV ,nrow = 2)
annotate_figure(big_MEV,top = text_grob("Marginal effect of Vaccination ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))



p_pv <- plot_externalities(pv_out, c(1,5,9), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIS <- plot_externalities(pv_out, c(1,2,3,4), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIR <- plot_externalities(pv_out, c(1,6,7,8),2:last_row, "Vaccine", "Vaccinations", "P(v)")

big_pv <- ggarrange(ggarrange(p_pv_SIS, p_pv_SIR, ncol = 2, labels = c("A", "B")), p_pv,nrow=2)
annotate_figure(big_pv,top = text_grob("Demand curve ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))

```
#### Fourth Scenario: 

* Vaccines for just half of the population 
* The vaccine is distributed according to R0 contribution
* Patches with connectivity.

```{r param_change2}

Vmax<- 1.5e6
vacc_distr <-ro/sum(ro)

```


 
```{r externalities4 , echo=FALSE, message=FALSE, warning=FALSE, error= FALSE}
ext <- vacc_externalities(npop=npop, alpha=alpha, rec=rec, ro=ro, N=N,ef=ef, I0=I0,Vmax=Vmax,vacc_distr=vacc_distr)

vaccine <- ext[,1]

MEV <- ext[,c(1:12)]

for (i in 2:length(vaccine)){
  
  MEV[i, c(5,6,7)] <-(ext[i, c(5,6,7)] - ext[i-1, c(5,6,7)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  MEV[i, c(8,12)] <- (ext[i, c(8,12)] - ext[i-1, c(8,12)]) / (ext[i,1] - ext[i-1,1])
  MEV[i, c(9,10,11)] <-(ext[i, c(9,10,11)] - ext[i-1, c(9,10,11)]) / ((ext[i,1] - ext[i-1,1])*vacc_distr)
  
  
}

pv_out <- ext[c(1,13:20)]

## ---- Plotting ---- ##
x <- MEV[2:(length(vaccine) -1),c(2,5)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "MEV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,6)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "MEV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,7)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "MEV","Patch")

plot_MEV <- rbind(x,y,z)

x <- MEV[2:(length(vaccine) -1),c(2,9)]
x[,3] <- "Low"
colnames(x) <- c("Vaccine", "MEV","Patch")

y <- MEV[2:(length(vaccine) -1),c(3,10)]
y[,3] <- "Medium"
colnames(y) <- c("Vaccine", "MEV","Patch")

z <- MEV[2:(length(vaccine) -1),c(4,11)]
z[,3] <- "High"
colnames(z) <- c("Vaccine", "MEV","Patch")


plot_PV <- rbind(x,y,z)


last_row <- length(vaccine) -1 

p_MEV <- plot_externalities(MEV, c(1,8,12), 2:last_row, "Vaccine", "Vaccinations", "MEV")
p_MEV_SIS <- ggplot(plot_MEV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIS")
p_MEV_SIR <- ggplot(plot_PV, aes(x = Vaccine, y = MEV , col = Patch)) + geom_line()+ xlab("Vaccine") + ylab("MEV") + ggtitle("SIR")

big_MEV <- ggarrange(ggarrange(p_MEV_SIS, p_MEV_SIR, ncol = 2, labels = c("A", "B")), p_MEV ,nrow = 2)
annotate_figure(big_MEV,top = text_grob("Marginal effect of Vaccination ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))



p_pv <- plot_externalities(pv_out, c(1,5,9), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIS <- plot_externalities(pv_out, c(1,2,3,4), 1:last_row,"Vaccine", "Vaccinations", "P(v)")
p_pv_SIR <- plot_externalities(pv_out, c(1,6,7,8),2:last_row, "Vaccine", "Vaccinations", "P(v)")

big_pv <- ggarrange(ggarrange(p_pv_SIS, p_pv_SIR, ncol = 2, labels = c("A", "B")), p_pv,nrow=2)
annotate_figure(big_pv,top = text_grob("Demand curve ", face = "bold", size = 14), bottom = text_grob("Connectivity - Equal distribution ", color = "blue",hjust = 1, x = 1, face = "italic", size = 10))

```

